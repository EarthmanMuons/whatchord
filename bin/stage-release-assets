#!/usr/bin/env bash
set -euo pipefail

die() {
	printf "ERROR: %s\n" "$*" >&2
	exit 2
}
info() { printf "INFO: %s\n" "$*" >&2; }

usage() {
	cat >&2 <<'EOF'
Stage Flutter release assets into dist/ with deterministic names + sha256sums.txt.

Usage:
  stage-release-assets --slug <slug> [--tag <tag>] [--dist <dir>]
EOF
}

slug=""
tag=""
dist_dir="dist"

while (($#)); do
	case "$1" in
	--slug)
		shift
		slug="${1-}"
		[[ -n $slug ]] || die "--slug requires a value"
		;;
	--tag)
		shift
		tag="${1-}"
		[[ -n $tag ]] || die "--tag requires a value"
		;;
	--dist)
		shift
		dist_dir="${1-}"
		[[ -n $dist_dir ]] || die "--dist requires a value"
		;;
	-h | --help)
		usage
		exit 0
		;;
	*) die "Unknown argument: $1" ;;
	esac
	shift
done

[[ -n $slug ]] || die "--slug is required."
[[ $slug =~ ^[a-z0-9]+$ ]] || die "slug must match ^[a-z0-9]+$ (got: '$slug')."

# Resolve tag with integrity rules:
# - In CI (GitHub Actions): must run on a tag ref; tag is *always* the triggering tag.
# - Locally: --tag is required.
if [[ ${GITHUB_ACTIONS-} == "true" ]]; then
	[[ ${GITHUB_REF_TYPE-} == "tag" ]] ||
		die "In CI, this script must run on a tag ref (GITHUB_REF_TYPE=tag)."

	[[ -z $tag ]] ||
		die "In CI, do not pass --tag; the workflow tag is used automatically."

	tag="${GITHUB_REF_NAME-}"
	[[ -n $tag ]] || die "In CI, GITHUB_REF_NAME was empty; expected a tag name."
else
	[[ -n $tag ]] || die "Tag not provided. Pass --tag <tag> locally."
fi

repo_root=""

# In GitHub Actions, this is authoritative and already correct.
if [[ -n ${GITHUB_WORKSPACE-} ]]; then
	repo_root=$GITHUB_WORKSPACE
else
	if command -v git >/dev/null 2>&1; then
		repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
	fi

	if [[ -z $repo_root ]] && command -v jj >/dev/null 2>&1; then
		repo_root="$(jj workspace root 2>/dev/null || true)"
	fi
fi

if [[ -z $repo_root ]]; then
	die "Could not determine repo root (not in a Git work tree or jj workspace)."
fi

cd "$repo_root"

apk_src="build/app/outputs/flutter-apk/app-release.apk"
aab_src="build/app/outputs/bundle/release/app-release.aab"

[[ -f $apk_src ]] || die "APK not found at: $apk_src"
[[ -f $aab_src ]] || die "AAB not found at: $aab_src"

mkdir -p -- "$dist_dir"

apk_file="${slug}-${tag}.apk"
aab_file="${slug}-${tag}.aab"
apk_dst="${dist_dir}/${apk_file}"
aab_dst="${dist_dir}/${aab_file}"

cp -v -- "$apk_src" "$apk_dst"
cp -v -- "$aab_src" "$aab_dst"

# Produce checksum file with bare filenames (run from within dist).
pushd "$dist_dir" >/dev/null
trap 'popd >/dev/null || true' RETURN

if command -v sha256sum >/dev/null 2>&1; then
	sha256sum -- "$apk_file" "$aab_file" >sha256sums.txt
elif command -v shasum >/dev/null 2>&1; then
	shasum -a 256 -- "$apk_file" "$aab_file" >sha256sums.txt
else
	die "Need sha256sum or shasum to generate SHA-256 checksums."
fi

info "Prepared assets in: $dist_dir"
info "  $apk_file"
info "  $aab_file"
info "  sha256sums.txt"
